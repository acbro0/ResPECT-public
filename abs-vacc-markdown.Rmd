---
title: "Absenteeism-and-vaccination"
author: "Alexandria C. Brown"
date: "Nov 14, 2016"
output: pdf_document
---

The following portion is run using qsub on the JHPCE cluster.
Load packages.

```{r, eval=FALSE}
require("tidyr")
require("dplyr")
require("MCMCglmm")
```

Get the data.

```{r, eval=FALSE}
wd <- read.csv("/users/nreich/respect/all-years-data-current/ResPECT-final-datasets/ResPECT-weekly-diaries.csv", stringsAsFactors=F)

exprep <- read.csv("/users/nreich/respect/all-years-data-current/ResPECT-final-datasets/daily-exposure-reports.csv", stringsAsFactors=F)

demog <- read.csv("/users/nreich/respect/all-years-data-current/ResPECT-final-datasets/ResPECT-demographics.csv", stringsAsFactors=F)
```

Get and organize the number of absent days for each participant.

```{r, eval=FALSE}
absent_days <- data.frame(wd$study_id, wd$absent_work_days, stringsAsFactors=FALSE)

colnames(absent_days) <- c("study_id", "days_absent")

absent_days$days_absent <- as.integer(absent_days$days_absent)

days <- absent_days %>% 
  filter(!is.na(days_absent)&days_absent!="") %>% 
  group_by(study_id) %>% 
  summarise(abs_days=sum(days_absent)) %>% 
  data.frame

absentee <- left_join(demog, days)

absentee$abs_days[is.na(absentee$abs_days)] <- 0
```

Assign a hospital type variable (VA vs PS)

```{r, eval=FALSE}
absentee$htype <- as.factor(ifelse (absentee$site == "1" | 
                                      absentee$site == "3" | 
                                      absentee$site == "4", 
                                    "PS", "VA"))
```

Mike and John did not want to include the first year, so drop it.

```{r, eval=FALSE}
absvax <- filter(absentee, year !=1)
```

Censure ineligible people, those who withdrew, and anyone 
who didn't report a vaccination status.
```{r, eval=FALSE}
absvax <- filter(absvax, study_completion_status== "completed")

#omit people who did not report their vaccination status
absvax <- filter(absvax, !is.na(vaccine_recieved))
```

I want to include self-reported hand hygiene in my models.
I took an average of each person's answers.

```{r, eval=FALSE}
hand <- exprep %>%
    filter(we_worktoday==1 & !is.na(we_worktoday)) %>%
    group_by(study_id) %>%
    summarise(avg_hand_hyg=mean(we_handhyg_freq, na.rm=T))

absvax <- left_join(absvax, hand)

#there are people who are causing my model to fail
#replace with mean for the population

absvax$avg_hand_hyg[is.na(absvax$avg_hand_hyg)] <-
    mean(absvax$avg_hand_hyg, na.rm=T)

absvax$age[is.na(absvax$age)] <-
    mean(absvax$age, na.rm=T)

absvax$URI_exposure_perc[is.na(absvax$URI_exposure_perc)] <-
    mean(absvax$URI_exposure_perc, na.rm=T)

```

Drop some unused columns.

```{r, eval=FALSE}
absvax <- select(absvax, study_id, masterid, abs_days, vaccine_recieved, htype, male,
       year, URI_exposure_perc, avg_hand_hyg, age)
```

Prior to building the model, check str() to make sure all the 
variables are of the appropriate type.

```{r, eval=FALSE}
absvax$year <- as.factor(absvax$year)
absvax$vaccine_recieved <- as.factor(absvax$vaccine_recieved)
absvax$male <- as.factor(absvax$male)
absvax$masterid <- as.factor(absvax$masterid)
```

Build the models and save them.

```{r, eval=FALSE}

#Are unvaccinated people more likely to take time off due to URI?

vacc_model <- MCMCglmm (abs_days~vaccine_recieved + htype +
                        male + year + URI_exposure_perc + avg_hand_hyg + age,
                              random = ~masterid,  
                              data = absvax, nitt = 2000000, burnin = 1000, thin=100,
                              rcov = ~trait:units, family = "hupoisson")

save(vacc_model, file="/home/bst/student/nreich/respect/ResPECT-R-compilation-code/R-code-for-ResPECT-side-projects/vacc-affect-abs-model1.RData")

#are vaccination policies associated with increased vaccination?

htype_model <- MCMCglmm (vaccine_recieved~htype + male +
                         year + URI_exposure_perc + avg_hand_hyg + age,
                        random = ~masterid,
                        data = absvax, nitt = 2000000, burnin = 1000, thin=100,
                        rcov = ~trait:units, family = "categorical")

save(htype_model, file="/home/bst/student/nreich/respect/ResPECT-R-compilation-code/R-code-for-ResPECT-side-projects/policy-affect-vacc-model2.RData")
```

The models will take a few hours to run.  When they are finished 
you can download the model outputs to your computer using scp
and work with them locally, which is helpful for creating plots.
Load the package used to create the
model or else the output doesn't make sense. While we're at it, load 
ggplot2 and dplyr also.

```{r}
require("MCMCglmm")
require("ggplot2")
require("dplyr")

load("/home/lex/Desktop/vacc-affect-abs-model1.RData")

summary(vacc_model)

load("/home/lex/Desktop/policy-affect-vacc-model2.RData")

summary(htype_model)     

load("/home/lex/Desktop/vacc-affect-abs-model-hurdle-no-masterid.RData")


```

Make some nice figures of the results.  

```{r}
vac <- summary(vacc_model)

vac <- data.frame(vac$solutions)

vac$predictors <- rownames(vac)

vac <- filter(vac, predictors != "(Intercept)")

vac$predictors <- c("vaccinated", "VA", 
                    "male", "2014", "2015", "URI exposure", 
                    "hand hygiene", "age")

ggplot(vac, aes(x = predictors, y = post.mean)) +                                                   
  theme_bw() + 
  geom_pointrange (aes (ymin = l.95..CI, ymax = u.95..CI)) +              
  coord_flip() +               
  geom_hline(aes(yintercept=0), lty=2) +           
  labs(y = "95% CI", x = NULL) +                 
  theme(axis.text = element_text(size=12),  axis.title=element_text(size=14,face="bold"))   
```

Here's the figure for the model that shows whether PS hospital type is associated 
with more vaccinated participants. 

```{r}
vac <- summary(htype_model)                                                                                                                                                                
vac <- data.frame(vac$solutions)

vac$predictors <- rownames(vac)

require(dplyr)

vac <- filter(vac, predictors != "(Intercept)")

vac$predictors <- c("VA", "male", "2014", "2015", "URI exposure",
                    "hand hygiene", "age")

ggplot(vac, aes(x = predictors, y = post.mean)) +                                
  theme_bw() +                                   
  geom_pointrange (aes (ymin = l.95..CI, ymax = u.95..CI)) +      
  geom_point()+                   
  coord_flip() +            
    geom_hline(aes(yintercept=0), lty=2) +         
  labs(y = "95% CI", x = NULL) +              
  theme(axis.text = element_text(size=12),  axis.title=element_text(size=14,face="bold"))     
```

Model diagnostics.  This is model 1 run seperately for each group, as suggested by Derek.


```{r}
load("/home/lex/Desktop/vacc-affect-abs-model1-PSonly.RData")

vacc_modelPS <- vacc_model

summary(vacc_modelPS)

load("/home/lex/Desktop/vacc-affect-abs-model1-VAonly.RData")

vacc_modelVA <- vacc_model

summary(vacc_modelVA)     
```

Make some figures of the results.  

```{r}
vac <- summary(vacc_modelVA)

vac <- data.frame(vac$solutions)

vac$predictors <- rownames(vac)

vac <- filter(vac, predictors != "(Intercept)")

vac$predictors <- c("vaccinated",
                    "male", "2014", "2015", "URI exposure", 
                    "hand hygiene", "age")

ggplot(vac, aes(x = predictors, y = post.mean)) +     
    ggtitle("Absenteeism Predictors within VA") +
  theme_bw() + 
  geom_pointrange (aes (ymin = l.95..CI, ymax = u.95..CI)) +              
  coord_flip() +               
  geom_hline(aes(yintercept=0), lty=2) +           
  labs(y = "95% CI", x = NULL) +                 
  theme(axis.text = element_text(size=12),  axis.title=element_text(size=14,face="bold"))   

vac <- summary(vacc_modelPS)

vac <- data.frame(vac$solutions)

vac$predictors <- rownames(vac)

vac <- filter(vac, predictors != "(Intercept)")

vac$predictors <- c("vaccinated",
                    "male", "2014", "2015", "URI exposure", 
                    "hand hygiene", "age")

ggplot(vac, aes(x = predictors, y = post.mean)) +                                                   
  ggtitle("Absenteeism Predictors within PS") +
  theme_bw() + 
  geom_pointrange (aes (ymin = l.95..CI, ymax = u.95..CI)) +              
  coord_flip() +               
  geom_hline(aes(yintercept=0), lty=2) +           
  labs(y = "95% CI", x = NULL) +                 
  theme(axis.text = element_text(size=12),  axis.title=element_text(size=14,face="bold"))   
```

